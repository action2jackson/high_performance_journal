{% extends 'journal/base.html' %}

{% load fullcalendar_tags %}

{% block title %}Daily Journal{% endblock %}

{% block content %}

    <script>
        $(document).ready(function () {
            $('#calendar').fullCalendar('render');
            var calendar = $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'agendaDay,agendaWeek'
                },
                events: [
                    {% for event in events %}
                        {
                            title: "{{ event.name }}",
                            start: '{{ event.start|date:"Y-m-d H:i:s" }}',
                            end: '{{ event.end|date:"Y-m-d H:i:s" }}',
                            id: '{{ event.id }}',
                            value: '{{ event.value }}',
                        },
                    {% endfor %} 
                ],
                selectable: true,
                selectHelper: true,
                editable: true,
                eventLimit: true,             
                defaultView: 'agendaDay',
                allDaySlot: false,
                allDayDefault: false,
                axisFormat: 'h(:mm)tt',
                timeFormat: 'h(:mm)tt{ - h(:mm)tt}',
                defaultEventMinutes: 1440,
                dragOpacity: {
                    agenda: .5
                },
                contentHeight: 800,
                // viewDisplay   : function(view) {
                //     var now = new Date(); 
                //     var end = new Date();
                //     end.setMonth(now.getMonth() + 3); //Adjust as needed

                //     var cal_date_string = view.start.getMonth()+'/'+view.start.getFullYear();
                //     var cur_date_string = now.getMonth()+'/'+now.getFullYear();
                //     var end_date_string = end.getMonth()+'/'+end.getFullYear();

                //     if(cal_date_string == cur_date_string) { jQuery('.fc-button-prev').addClass("fc-state-disabled");
                //     } 
                //     else { jQuery('.fc-button-prev').removeClass("fc-state-disabled"); }

                //     if (end_date_string == cal_date_string) { jQuery('.fc-button-next').addClass("fc-state-disabled");
                //     }
                //     else { jQuery('.fc-button-next').removeClass("fc-state-disabled"); }
                // },
                select: function (start, end) {
                    var title;
                    var value;
                    start = $.fullCalendar.formatDate(start, 'yyyy-MM-dd HH:mm:ss');
                    end = $.fullCalendar.formatDate(end, 'yyyy-MM-dd HH:mm:ss');
                    var eventData = {}
                    Swal.fire({
                        html:
                            '<div class="inputContainer"><input type="text" placeholder="Title" id="eventTitle" class="swal2-input"></div>' +
                            '<div class="inputContainer"><label>Start Date (optional)</label><input type="datetime-local" id="eventStartDate" class="swal2-input"></div>' +
                            '<div class="inputContainer"><label>End Date (optional)</label><input type="datetime-local" id="eventEndDate" class="swal2-input"></div>' +
                            '<div id="eventTaskReminder">' +
                                '<div class="radioContainer"><input type="radio" name="EventTaskReminder" id="event" class="radio"></div>' +
                                '<div class="radioContainer"><input type="radio" name="EventTaskReminder" id="task" class="radio"></div>' +
                                '<div class="radioContainer"><input type="radio" name="EventTaskReminder" id="reminder" class="radio"></div>' +
                            '</div>',
                        focusConfirm: false,
                        showConfirmButton: true,
                        confirmButtonText: "CREATE",
                        preConfirm: function () {
                            var radioInputs = document.getElementsByName('EventTaskReminder');
                            for (var i=0; i<radioInputs.length; i++) {
                                if (radioInputs[i].checked) {
                                    value = radioInputs[i].id;
                                    break;
                                } 
                            }
                            if($("#eventTitle").val() && value) {
                                title = document.getElementById("eventTitle").value
                                if ($("#eventStartDate").val()) {
                                    start = document.getElementById("eventStartDate").value
                                }
                                if ($("#eventEndDate").val()) {
                                    end = document.getElementById("eventEndDate").value
                                }
                                eventData = {
                                    title: title,
                                    start: start,
                                    end: end,
                                    value: value
                                };
                                $.ajax({
                                    type: "GET",
                                    url: '{% url "add_event" %}',
                                    data: {'title': title, 'start': start, 'end': end, 'value': value},
                                    dataType: "json",
                                    success: function (data) {
                                        $('#calendar').fullCalendar('renderEvent', eventData, true);
                                    },
                                    failure: function (data) {
                                        alert('There is a problem!!!');
                                    }
                                });
                            }
                        },
                    })
                },
                eventRender: function(event, element, value) {
                    if (event.value == "task") {
                        element.css("background", "#0CB4B4")
                        element.css("border-color", "#0CB4B4")   
                    }
                    else if (event.value == "reminder") {
                        element.css("background", "red")
                        element.css("border-color", "red")
                    } 
                    else {
                        element.css("background", "rgba(0,0,0,0.9)")
                        element.css("border-color", "rgba(0,0,0,0.9)")                      
                    }
                },
                eventResize: function (event) {
                    var start = $.fullCalendar.formatDate(event.start, 'yyyy-MM-dd HH:mm:ss');
                    var end = $.fullCalendar.formatDate(event.end, 'yyyy-MM-dd HH:mm:ss');
                    var title = event.title;
                    var value = event.value
                    var id = event.id;
                    calendar.fullCalendar('unselect');
                    $.ajax({
                        type: "GET",
                        url: '/update',
                        data: {'title': title, 'start': start, 'end': end, 'value': value, 'id': id},
                        dataType: "json",
                        success: function (data) {
                            calendar.fullCalendar('refetchEvents');
                        },
                        failure: function (data) {
                            alert('There is a problem!!!');
                        }
                    });
                },

                eventDrop: function (event) {
                    var start = $.fullCalendar.formatDate(event.start, 'yyyy-MM-dd HH:mm:ss');
                    var end = $.fullCalendar.formatDate(event.end, 'yyyy-MM-dd HH:mm:ss');
                    var title = event.title;
                    var value = event.value
                    var id = event.id;
                    $.ajax({
                        type: "GET",
                        data: {'title': title, 'start': start, 'end': end, 'value': value, 'id': id},
                        dataType: "json",
                        url: '/update',
                        success: function (data) {
                            calendar.fullCalendar('refetchEvent');
                        },
                        failure: function (data) {
                            alert('There is a problem!!!');
                        }
                    });
                },

                eventClick: function (event) {
                    var id = event.id;
                    Swal.fire({
                        showConfirmButton: true,
                        confirmButtonText: 'DELETE FROM CALENDAR',
                        confirmButtonColor: 'red',
                        showCancelButton: true,
                        cancelButtonText: 'Keep it!',
                    })
                    .then((willDelete) => {
                        if (willDelete.isConfirmed) {
                            $.ajax({
                                type: "GET",
                                url: '/remove',
                                data: {'id': id},
                                dataType: "json",
                                success: function (data) {
                                    $('#calendar').fullCalendar('removeEvents', id);  
                                },
                                failure: function (data) {
                                    alert('There is a problem!!!');
                                }
                            });
                        }
                    });
                },
            });
        });

    </script>
    <div class="main_journal_container">
        {% fullcalendar_css %}        
        {% fullcalendar_print_css %}        
        {% fullcalendar_jquery %}
        {% fullcalendar_jquery_ui %}
        {% fullcalendar_javascript %}

        <div class="container">
            <div id="calendar"></div>
        </div>
    </div>
{% endblock %}